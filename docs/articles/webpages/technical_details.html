<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Technical details • greta</title>
<link rel="shortcut icon" type="image/x-icon" href="../../favicon.ico">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.1/clipboard.min.js" integrity="sha256-hIvIxeqhGZF+VVeM55k0mJvWpQ6gTkWk3Emc+NmowYA=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><!-- docsearch --><script src="../../docsearch.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css">
<link href="../../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Technical details">
<meta property="og:description" content="">
<meta property="og:image" content="https://greta-stats.org/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><style type="text/css">
.logo {
    display: inline-block;
    width: 144px;
    height: 40px;
    background-image: url(../../reference/figures/name_icon_on_purple.png);
    background-size: 100% auto;
    background-repeat: no-repeat;
    vertical-align: middle;
}
</style>
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    <a class="logo" href="../../index.html"></a>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../articles/get_started.html">get started</a>
</li>
<li>
  <a href="../../reference/index.html">docs</a>
</li>
<li>
  <a href="../../articles/example_models.html">examples</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    analyses
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/analyses/eight_schools.html">eight schools</a>
    </li>
    <li>
      <a href="../../articles/analyses/election_88.html">election 88</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    more
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/webpages/why_greta.html">why 'greta'?</a>
    </li>
    <li>
      <a href="../../articles/webpages/technical_details.html">technical details</a>
    </li>
    <li>
      <a href="../../articles/webpages/software.html">software</a>
    </li>
    <li>
      <a href="../../articles/webpages/contribute.html">contribute to greta</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../articles/faq.html">FAQ</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://forum.greta-stats.org">
    <span class="fa fa-lg fa-comments"></span>
     
  </a>
</li>
<li>
  <a href="http://twitter.com/greta_stats">
    <span class="fa fa-lg fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/greta-dev/greta">
    <span class="fa fa-lg fa-github"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><hr style="height:5px; visibility:hidden;">
<hr>
<script src="technical_details_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Technical details</h1>
            
      
    </div>

    
    
<p>This page provides technical implementation details for potential contributors or the curious. You don’t need to read this to be able to use greta.</p>
<div id="greta-arrays-nodes-and-tensors" class="section level2">
<h2 class="hasAnchor">
<a href="#greta-arrays-nodes-and-tensors" class="anchor"></a>greta arrays, nodes and tensors</h2>
<p>There are three layers to how greta defines a model: users manipulate <em>greta arrays</em>, these define <em>nodes</em>, and nodes then define <em>Tensors</em>.</p>
<div id="greta-arrays" class="section level3">
<h3 class="hasAnchor">
<a href="#greta-arrays" class="anchor"></a>greta arrays</h3>
<p>greta arrays are the user-facing representation of the model. greta arrays extend R arrays and have the classes <code>greta_array</code> and <code>array</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">ones</span>(<span class="dv">3</span>, <span class="dv">3</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(x)</span></code></pre></div>
<pre><code>[1] "greta_array" "array"      </code></pre>
</div>
<div id="nodes" class="section level3">
<h3 class="hasAnchor">
<a href="#nodes" class="anchor"></a>nodes</h3>
<p>The main difference between greta arrays and R arrays is that greta array has a <code>node</code> attribute; an R6 object inheriting from the R6 class ‘node’, as well as one of the three node types: ‘data’, ‘operation’ or ‘variable’.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>x_node <span class="ot">&lt;-</span> <span class="fu">attr</span>(x, <span class="st">"node"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(x_node)</span></code></pre></div>
<pre><code>[1] "data_node" "node"      "R6"       </code></pre>
<p>There is a fourth node type: ‘distribution’, but these are never directly associated with greta arrays.</p>
<p>These R6 node objects are where the magic happens. When created, each node points to its ‘parent’ nodes - the nodes for the greta arrays that were used to create this one.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># data nodes have no parents</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(x_node<span class="sc">$</span>parents)</span></code></pre></div>
<pre><code>[1] 0</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># operation nodes have one or more parents</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> x <span class="sc">*</span> <span class="dv">3</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>z_node <span class="ot">&lt;-</span> <span class="fu">attr</span>(z, <span class="st">"node"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(z_node<span class="sc">$</span>parents)</span></code></pre></div>
<pre><code>[1] 2</code></pre>
<p>Each node also has a list of its children, the nodes that have been created from this one.</p>
<p>When <code><a href="../../reference/model.html">model()</a></code> is called, that inheritance information is used to construct the directed acyclic graph (DAG) that defines the model. The inheritance also preserves intermediate nodes, such as those creates in multi-part operations, but not assigned as greta arrays.</p>
<p>Nodes also have a value member, which is an array for data nodes or an ‘unknowns’ object for other node types. The unknowns class is a thin wrapper around arrays, which prints the question marks. Generic functions for working on arrays (e.g. <code>dim</code>, <code>length</code>, <code>print</code>) use these node values to return something familiar to the user.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>x_node<span class="sc">$</span><span class="fu">value</span>()</span></code></pre></div>
<pre><code>     [,1] [,2] [,3]
[1,]    1    1    1
[2,]    1    1    1
[3,]    1    1    1</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># R calls this a matrix because it's 2d, but it's an array</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(x_node<span class="sc">$</span><span class="fu">value</span>())</span></code></pre></div>
<pre><code>[1] "matrix" "array" </code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>z_node<span class="sc">$</span><span class="fu">value</span>()</span></code></pre></div>
<pre><code>     [,1] [,2] [,3]
[1,]  ?    ?    ?  
[2,]  ?    ?    ?  
[3,]  ?    ?    ?  </code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(z_node<span class="sc">$</span><span class="fu">value</span>())</span></code></pre></div>
<pre><code>[1] "unknowns" "matrix"   "array"   </code></pre>
</div>
<div id="tensors" class="section level3">
<h3 class="hasAnchor">
<a href="#tensors" class="anchor"></a>Tensors</h3>
<p>In addition to remembering their shape and size and where they are in the DAG, each node has methods to define a corresponding TensorFlow Tensor object in a specified environment. That doesn’t happen until the user runs <code><a href="../../reference/model.html">model()</a></code>, which creates a ‘dag_class’ object to store the relevant nodes, the environment for the tensors, and methods to talk to the TensorFlow graph.</p>
<p>The node <code>tf()</code> method takes the DAG as an argument, and defines a tensor representing itself in the tensorflow environment, with a name determined by the dag object.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>x_node<span class="sc">$</span>tf</span></code></pre></div>
<pre><code>function(dag) {
      tfe &lt;- dag$tf_environment
      tf_name &lt;- dag$tf_name(self)
      unbatched_name &lt;- glue::glue("{tf_name}_unbatched")

      mode &lt;- dag$how_to_define(self)

      # if we're in sampling mode, get the distribution constructor and sample
      if (mode == "sampling") {
        batched_tensor &lt;- dag$draw_sample(self$distribution)
      }

      # if we're defining the forward mode graph, create either a constant or a
      # placeholder
      if (mode == "forward") {
        value &lt;- self$value()
        ndim &lt;- length(dim(value))
        shape &lt;- to_shape(c(1, dim(value)))
        value &lt;- add_first_dim(value)

        # under some circumstances we define data as constants, but normally as
        # placeholders
        using_constants &lt;- !is.null(greta_stash$data_as_constants)

        if (using_constants) {
          unbatched_tensor &lt;- tf$constant(
            value = value,
            dtype = tf_float(),
            shape = shape
          )
        } else {
          unbatched_tensor &lt;- tf$compat$v1$placeholder(
            shape = shape,
            dtype = tf_float()
          )
          dag$set_tf_data_list(unbatched_name, value)
        }

        # expand up to batch size
        tiling &lt;- c(tfe$batch_size, rep(1L, ndim))
        batched_tensor &lt;- tf$tile(unbatched_tensor, tiling)

        # put unbatched tensor in environment so it can be set
        assign(unbatched_name, unbatched_tensor, envir = tfe)
      }

      assign(tf_name, batched_tensor, envir = tfe)
    }
&lt;environment: 0x7fd0316e1698&gt;</code></pre>
<p>Because R6 objects are pass-by-reference (rather than pass-by-value), the dag accumulates all of the defined tensors, rather than being re-written each time. Similarly, because nodes are R6 objects and know which are their parents, they can make sure those parents are defined as tensors before they are. The <code>define_tf()</code> member function ensures that that happens, enabling operation nodes to use the tensors for their parents when defining their own tensor.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>x_node<span class="sc">$</span>define_tf</span></code></pre></div>
<pre><code>function(dag) {

      # if defined already, skip
      if (!self$defined(dag)) {

        # make sure parents are defined
        parents_defined &lt;- vapply(self$list_parents(dag),
          function(x) x$defined(dag),
          FUN.VALUE = FALSE
        )

        if (any(!parents_defined)) {
          parents &lt;- self$list_parents(dag)
          lapply(
            parents[which(!parents_defined)],
            function(x) x$define_tf(dag)
          )
        }

        # then define self
        self$tf(dag)
      }
    }
&lt;environment: 0x7fd0316e3660&gt;</code></pre>
</div>
</div>
<div id="variables-and-free-states" class="section level2">
<h2 class="hasAnchor">
<a href="#variables-and-free-states" class="anchor"></a>variables and free states</h2>
<p>Hamiltonian Monte Carlo (HMC) requires all of the parameters to be transformed to a continuous scale for sampling. Variable nodes are therefore converted to tensors by first defining a ‘free’ (unconstrained) version of themselves as a tensor, and then applying a transformation function to convert them back to the scale of interest.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">variable</span>(<span class="at">lower =</span> <span class="dv">0</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>a_node <span class="ot">&lt;-</span> <span class="fu">attr</span>(a, <span class="st">"node"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(a_node)</span></code></pre></div>
<pre><code>[1] "variable_node" "node"          "R6"           </code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>a_node<span class="sc">$</span>tf_from_free</span></code></pre></div>
<pre><code>function(x) {
      tf_bijector &lt;- self$create_tf_bijector()
      tf_bijector$forward(x)
    }
&lt;environment: 0x7fd032a20b38&gt;</code></pre>
</div>
<div id="distributions" class="section level2">
<h2 class="hasAnchor">
<a href="#distributions" class="anchor"></a>distributions</h2>
<p>distribution nodes are node objects just like the others, but they are not <em>directly</em> associated with greta arrays. Instead, greta arrays may have a distribution node in their <code>distribution</code> slot to indicate that their values are assumed to follow that distribution. The distribution node will also be listed as a child node, and likewise the ‘target node’ will be listed as a child of the distribution. Distribution nodes also have child nodes (data, variables or operations) representing their parameters.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>b_node <span class="ot">&lt;-</span> <span class="fu">attr</span>(b, <span class="st">"node"</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(b_node)</span></code></pre></div>
<pre><code>[1] "variable_node" "node"          "R6"           </code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(b_node<span class="sc">$</span>distribution)</span></code></pre></div>
<pre><code>[1] "normal_distribution" "distribution_node"   "node"               
[4] "R6"                 </code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># b is the target of its own distribution</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(b_node<span class="sc">$</span>distribution<span class="sc">$</span>target)</span></code></pre></div>
<pre><code>[1] "variable_node" "node"          "R6"           </code></pre>
<p>When they define themselves as tensors, distribution nodes define the log density of their target node/tensor given the tensors representing their parameters.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>b_node<span class="sc">$</span>distribution<span class="sc">$</span>tf</span></code></pre></div>
<pre><code>function(dag) {

      # assign the distribution object constructor function to the environment
      assign(dag$tf_name(self),
        self$tf_distrib,
        envir = dag$tf_environment
      )
    }
&lt;environment: 0x7fd0323e2ae8&gt;</code></pre>
<p>If the distribution was truncated, the log density is normalised using the cumulative distribution function.</p>
</div>
<div id="joint-density" class="section level2">
<h2 class="hasAnchor">
<a href="#joint-density" class="anchor"></a>Joint density</h2>
<p>Those log-densities for these distributions are summed on the TensorFlow graph to create a Tensor for the joint log-density of the model. TensorFlow’s automatic gradient capabilities are then used to define a Tensor for the gradient of the log-density with respect to each parameter in the model.</p>
<p>The <code>dag</code> R6 object contained within the model then exposes methods to send parameters to the TensorFlow graph and return the joint density and gradient.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">model</span>(b)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>dag<span class="sc">$</span>send_parameters</span></code></pre></div>
<pre><code>function(parameters) {

      # reshape to a row vector if needed
      if (is.null(dim(parameters))) {
        parameters &lt;- array(parameters, dim = c(1, length(parameters)))
      }

      # create a feed dict in the TF environment
      parameter_list &lt;- list(free_state = parameters)

      # set the batch size to match parameters
      self$set_tf_data_list("batch_size", nrow(parameters))

      self$build_feed_dict(parameter_list)
    }
&lt;environment: 0x7fd03289b008&gt;</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>dag<span class="sc">$</span>log_density</span></code></pre></div>
<pre><code>function() {
      res &lt;- cleanly(self$tf_sess_run(joint_density_adj))

      if (inherits(res, "error")) {
        res &lt;- NA
      }

      res
    }
&lt;environment: 0x7fd03289b008&gt;</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>dag<span class="sc">$</span>gradients</span></code></pre></div>
<pre><code>NULL</code></pre>
<p>These methods are used to check the validity of initial values, sampling is now done using samplers from tensorflow probability, which require a function mapping from the overall free state to the joint log density. That’s created with the <code>generate_log_prob_function</code> method:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>model<span class="sc">$</span>dag<span class="sc">$</span>generate_log_prob_function</span></code></pre></div>
<pre><code>function(which = c(
                                            "adjusted",
                                            "unadjusted",
                                            "both"
                                          )) {
      which &lt;- match.arg(which)

      function(free_state) {

        # temporarily define a new environment
        tfe_old &lt;- self$tf_environment
        on.exit(self$tf_environment &lt;- tfe_old)
        tfe &lt;- self$tf_environment &lt;- new.env()

        # copy the placeholders over here, so they aren't recreated
        data_names &lt;- self$get_tf_names(types = "data")
        for (name in data_names) {
          tfe[[name]] &lt;- tfe_old[[name]]
        }
        tfe$batch_size &lt;- tfe_old$batch_size

        # put the free state in the environment, and build out the tf graph
        tfe$free_state &lt;- free_state
        self$define_tf_body()

        # define the densities
        self$define_joint_density()

        objectives &lt;- list(
          adjusted = tfe$joint_density_adj,
          unadjusted = tfe$joint_density
        )

        # return either of the densities, or a list of both
        result &lt;- switch(which,
          adjusted = objectives$adjusted,
          unadjusted = objectives$unadjusted,
          both = objectives
        )

        result
      }
    }
&lt;environment: 0x7fd03289b008&gt;</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <ul class="nav nav-pills nav-stacked">
<li><a href="#greta-arrays-nodes-and-tensors">greta arrays, nodes and tensors</a></li>
      <li><a href="#variables-and-free-states">variables and free states</a></li>
      <li><a href="#distributions">distributions</a></li>
      <li><a href="#joint-density">Joint density</a></li>
      </ul>
</div>
      </div>

</div>


      <footer></footer>
</div>

  
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script>
  docsearch({
    
    
    apiKey: 'fa1406e0044eae29be11408a723039e7',
    indexName: 'greta',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
