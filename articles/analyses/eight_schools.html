<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Eight Schools Example Analysis • greta</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><!-- docsearch --><script src="../../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Eight Schools Example Analysis">
<meta property="og:description" content="greta">
<meta property="og:image" content="https://greta-stats.org/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><style type="text/css">
.logo {
    display: inline-block;
    width: 144px;
    height: 40px;
    background-image: url(../../reference/figures/name_icon_on_purple.png);
    background-size: 100% auto;
    background-repeat: no-repeat;
    vertical-align: middle;
}
</style>
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    <a class="logo" href="../../index.html"></a>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../articles/get_started.html">get started</a>
</li>
<li>
  <a href="../../reference/index.html">docs</a>
</li>
<li>
  <a href="../../articles/example_models.html">examples</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    analyses
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/analyses/eight_schools.html">eight schools</a>
    </li>
    <li>
      <a href="../../articles/analyses/election_88.html">election 88</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    more
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/webpages/why_greta.html">why 'greta'?</a>
    </li>
    <li>
      <a href="../../articles/webpages/technical_details.html">technical details</a>
    </li>
    <li>
      <a href="../../articles/webpages/software.html">software</a>
    </li>
    <li>
      <a href="../../articles/webpages/contribute.html">contribute to greta</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://forum.greta-stats.org">
    <span class="fas fa-lg fa-comments"></span>
     
  </a>
</li>
<li>
  <a href="http://twitter.com/greta_stats">
    <span class="fas fa-lg fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/greta-dev/greta">
    <span class="fas fa-lg fa-github"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><hr style="height:5px; visibility:hidden;">
<hr>
<script src="eight_schools_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Eight Schools Example Analysis</h1>
                        <h4 class="author">Shirin Glander, Tiphaine Martin, Matt Mulvahill, Michael Quinn, David Smith</h4>
            
      
    </div>

    
    
<div id="data" class="section level2">
<h2 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h2>
<p><strong>Eight Schools</strong> is a study of coaching effects from eight schools; it comes from <a href="https://www.jstatsoft.org/article/view/v012i03/v12i03.pdf">section 5.5 of Gelman et al. (2003) as covered in 2.1. Schools data of ‘R2WinBUGS: A Package for Running WinBUGS from R’</a>:</p>
<blockquote>
<p>The Scholastic Aptitude Test (SAT) measures the aptitude of high-schoolers in order to help colleges to make admissions decisions. It is divided into two parts, verbal (SAT-V) and mathematical (SAT-M). Our data comes from the SAT-V (Scholastic Aptitude Test-Verbal) on eight different high schools, from an experiment conducted in the late 1970s. SAT-V is a standard multiple choice test administered by the Educational Testing Service. This Service was interested in the effects of coaching programs for each of the selected schools. The study included coached and uncoached pupils, about sixty in each of the eight different schools; see Rubin (1981). All of them had already taken the PSAT (Preliminary SAT) which results were used as covariates. For each school, the estimated treatment effect and the standard error of the effect estimate are given. These are calculated by an analysis of covariance adjustment appropriate for a completely randomized experiment (Rubin 1981). This example was analysed using a hierarchical normal model in Rubin (1981) and Gelman, Carlin, Stern, and Rubin (2003, Section 5.5).</p>
</blockquote>
<p>The corresponding <a href="https://medium.com/tensorflow/introducing-tensorflow-probability-dca4c304e245">TensorFlow Probability</a> Jupyter notebook can be found <a href="https://github.com/tensorflow/probability/blob/master/tensorflow_probability/examples/jupyter_notebooks/Eight_Schools.ipynb">here</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://greta-stats.org">greta</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/">bayesplot</a></span><span class="op">)</span>
<span class="fu"><a href="https://mc-stan.org/bayesplot/reference/bayesplot-colors.html">color_scheme_set</a></span><span class="op">(</span><span class="st">"purple"</span><span class="op">)</span></code></pre></div>
<pre class="text"><code># data
N &lt;- letters[1:8]
treatment_effects &lt;- c(28.39, 7.94, -2.75 , 6.82, -0.64, 0.63, 18.01, 12.16)
treatment_stddevs &lt;- c(14.9, 10.2, 16.3, 11.0, 9.4, 11.4, 10.4, 17.6)</code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">schools</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>N <span class="op">=</span> <span class="va">N</span>,
                      treatment_effects <span class="op">=</span> <span class="va">treatment_effects</span>,
                      treatment_stddevs <span class="op">=</span> <span class="va">treatment_stddevs</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>treatment_effects_p_stddevs <span class="op">=</span> <span class="va">treatment_effects</span> <span class="op">+</span> <span class="va">treatment_stddevs</span>,
         treatment_effects_m_stddevs <span class="op">=</span> <span class="va">treatment_effects</span> <span class="op">-</span> <span class="va">treatment_stddevs</span><span class="op">)</span></code></pre></div>
<p>For each the eight schools <code>N</code> we have the estimated treatment effect (<code>treatment_effects</code>) plus standard error (<code>treatment_stddevs</code>). Below, we are replicating the barplot from the <a href="https://github.com/tensorflow/probability/blob/master/tensorflow_probability/examples/jupyter_notebooks/Eight_Schools.ipynb">TensorFlow Probability example</a> that shows the estimated treatment effects +/- standard error per school:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">schools</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">N</span>, y <span class="op">=</span> <span class="va">treatment_effects</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_bar</span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>, fill <span class="op">=</span> <span class="st">"purple"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_errorbar</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">treatment_effects_m_stddevs</span>, ymax <span class="op">=</span> <span class="va">treatment_effects_p_stddevs</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"school"</span>, y <span class="op">=</span> <span class="st">"treatment effect"</span>,
       title <span class="op">=</span> <span class="st">"Barplot of treatment effects for eight schools"</span>,
       subtitle <span class="op">=</span> <span class="st">"Error bars represent standard error"</span><span class="op">)</span></code></pre></div>
<p>A different way to plot the estimated effects and their standard errors is to plot the density distribution over the eight schools we have:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">schools</span> <span class="op">%&gt;%</span>
  <span class="fu">gather</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">treatment_effects</span>, <span class="va">treatment_effects_p_stddevs</span>, <span class="va">treatment_effects_m_stddevs</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_density</span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"purple"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">scale_color_brewer</span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Set1"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"treatment effect (+/- standard error)"</span>,
         color <span class="op">=</span> <span class="st">"density curve of"</span>,
         title <span class="op">=</span> <span class="st">"Density plot of treatment effects +/- standard error for eight schools"</span><span class="op">)</span></code></pre></div>
</div>
<div id="modelling-with-greta" class="section level2">
<h2 class="hasAnchor">
<a href="#modelling-with-greta" class="anchor"></a>Modelling with <code>greta</code>
</h2>
<p>To model the data, we use the same hierarchical normal model as in the <a href="https://github.com/tensorflow/probability/blob/master/tensorflow_probability/examples/jupyter_notebooks/Eight_Schools.ipynb">TensorFlow Probability example</a>.</p>
<div id="variables-and-priors" class="section level3">
<h3 class="hasAnchor">
<a href="#variables-and-priors" class="anchor"></a>Variables and priors</h3>
<p>First, we create greta arrays that represent the variables and prior distributions in our model and create a greta array for school effect from them. We define the following (random) variables and priors:</p>
<ul>
<li>
<code>avg_effect</code>: normal density function (<code>dnorm</code>) with a mean of <code>0</code> and standard deviation of <code>10</code>; represents the prior average treatment effect.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">avg_effect</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/distributions.html">normal</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="va">avg_effect</span></code></pre></div>
<ul>
<li>
<code>avg_stddev</code>: normal density function (<code>dnorm</code>) with a mean of <code>5</code> and standard deviation of <code>1</code>; controls the amount of variance between schools.</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">avg_stddev</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/distributions.html">normal</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">avg_stddev</span></code></pre></div>
<ul>
<li>
<code>school_effects_standard</code>: normal density function (<code>dnorm</code>) with a mean of <code>0</code>, standard deviation of <code>1</code> and dimension of <code>8</code>
</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">school_effects_standard</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/distributions.html">normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>
<span class="va">school_effects_standard</span></code></pre></div>
<ul>
<li>
<code>school_effects</code>: here we multiply the exponential of <code>avg_stddev</code> with <code>school_effects_standard</code> and add <code>avg_effect</code>
</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">school_effects</span> <span class="op">&lt;-</span> <span class="va">avg_effect</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">avg_stddev</span><span class="op">)</span> <span class="op">*</span> <span class="va">school_effects_standard</span>
<span class="va">school_effects</span></code></pre></div>
<p>An alternative would be to directly use the <code><a href="../../reference/distributions.html">lognormal()</a></code> density function for <code>avg_stddev</code> and use that to calculate <code>school_effect</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">avg_stddev</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/distributions.html">lognormal</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">school_effects</span> <span class="op">&lt;-</span> <span class="va">avg_effect</span> <span class="op">+</span> <span class="va">avg_stddev</span> <span class="op">*</span> <span class="va">school_effects_standard</span></code></pre></div>
</div>
<div id="likelihood" class="section level3">
<h3 class="hasAnchor">
<a href="#likelihood" class="anchor"></a>Likelihood</h3>
<p>Next, we want to link the variables and priors with the observed dependent data - in this case the school estimate <code>treatment_effects</code>. We define the likelihood over our observed estimates <code>treatment_effects</code> given a random sample from the normal probability distribution with mean <code>school_effects</code> and standard deviation <code>treatment_stddevs</code>. From this, we would now like to calculate the parameter of that probability distribution by using the <code><a href="../../reference/distribution.html">distribution()</a></code> function:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../../reference/distribution.html">distribution</a></span><span class="op">(</span><span class="va">treatment_effects</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/distributions.html">normal</a></span><span class="op">(</span><span class="va">school_effects</span>, <span class="va">treatment_stddevs</span><span class="op">)</span></code></pre></div>
</div>
<div id="bayesian-inference-model" class="section level3">
<h3 class="hasAnchor">
<a href="#bayesian-inference-model" class="anchor"></a>Bayesian inference model</h3>
<p>Now we have all the prerequisites for building a Hamiltonian Monte Carlo (HMC) to calculate the posterior distribution over the model’s parameters.</p>
<p>We first define the model by combining the calculated <code>avg_effect</code>, <code>avg_stddev</code> and <code>school_effects_standard</code> variables so that we can sample from them during modelling. The model <code>m</code> we define below contains all our prior distributions and thus represent the combined density of the model.</p>
<p>It is recommended that you check your model at this step by plotting the model graph. More information about these plots can be found <a href="https://greta-stats.org/articles/get_started.html#plotting">here</a>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># defining the hierarchical model</span>
<span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/model.html">model</a></span><span class="op">(</span><span class="va">avg_effect</span>, <span class="va">avg_stddev</span>, <span class="va">school_effects_standard</span><span class="op">)</span>
<span class="va">m</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></code></pre></div>
<p>The actual sampling from the model happens with the <code><a href="../../reference/inference.html">mcmc()</a></code> function. By default 1000 MCMC samples are drawn after warm-up. What we obtain is a probability measure that describes the likelihood of a set of randomly sampled values for the model variables.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># sampling</span>
<span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu">greta</span><span class="fu">::</span><span class="fu"><a href="../../reference/inference.html">mcmc</a></span><span class="op">(</span><span class="va">m</span>, n_samples <span class="op">=</span> <span class="fl">1000</span>, warmup <span class="op">=</span> <span class="fl">1000</span>, chains <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-traces.html">mcmc_trace</a></span><span class="op">(</span><span class="va">draws</span>, facet_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-intervals.html">mcmc_intervals</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-diagnostics.html">mcmc_acf_bar</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-distributions.html">mcmc_hist</a></span><span class="op">(</span><span class="va">draws</span>, facet_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div id="use-of-calculate-for-transforming-estimates-to-natural-scale" class="section level4">
<h4 class="hasAnchor">
<a href="#use-of-calculate-for-transforming-estimates-to-natural-scale" class="anchor"></a>Use of <code>calculate()</code> for transforming estimates to natural scale</h4>
<p>The <code><a href="../../reference/calculate.html">calculate()</a></code> function can be used with the transformation function used in building the model to get the school-specific posteriors chains. This function is also how you would get posterior predictive values.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Calculate school effects on original scale</span>
<span class="va">school_effects</span>           <span class="op">&lt;-</span> <span class="va">avg_effect</span> <span class="op">+</span> <span class="va">avg_stddev</span> <span class="op">*</span> <span class="va">school_effects_standard</span>
<span class="va">posterior_school_effects</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/calculate.html">calculate</a></span><span class="op">(</span><span class="va">school_effects</span>, <span class="va">draws</span><span class="op">)</span> </code></pre></div>
</div>
<div id="comparison-with-edward2-hmc" class="section level4">
<h4 class="hasAnchor">
<a href="#comparison-with-edward2-hmc" class="anchor"></a>Comparison with Edward2 HMC</h4>
<p>As a sanity check that we parameterized our model correctly, we can compare the back-transformed school-specific estimates to the results from the Edward2 approach <a href="https://github.com/tensorflow/probability/blob/master/tensorflow_probability/examples/jupyter_notebooks/Eight_Schools.ipynb">in the TensorFlow Probability documentation</a>. The results are very similar.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Posterior means via Edward2</span>
<span class="va">edward2_school_means</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>tool <span class="op">=</span> <span class="st">"Edward2"</span>,
             school <span class="op">=</span> <span class="va">N</span>,
             <span class="co">#mean_school_effects_standard = c(0.61157268, 0.06430732, -0.25459746,</span>
             <span class="co">#                                 0.04828103, -0.36940941, -0.23154463,</span>
             <span class="co">#                                 0.49402338,  0.13042814),</span>
             mean <span class="op">=</span> <span class="fu"><a href="../../reference/extract-replace-combine.html">c</a></span><span class="op">(</span><span class="fl">14.93237686</span>, <span class="fl">7.50939941</span>, <span class="fl">3.07602358</span>, <span class="fl">7.21652555</span>,
                                     <span class="fl">2.0329783</span>, <span class="fl">3.41213799</span>, <span class="fl">12.92509365</span>, <span class="fl">8.36702347</span><span class="op">)</span>,
             sd <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>

<span class="va">edward2_pop_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>tool <span class="op">=</span> <span class="st">"Edward2"</span>, <span class="st">'mean'</span> <span class="op">=</span> <span class="fl">6.48866844177</span>, <span class="st">'sd'</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="co"># hmc_mean_avg_stddev &lt;- 2.46163249016</span>


<span class="va">posterior_school_effects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">posterior_school_effects</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Relabel school measures</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">posterior_school_effects</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">N</span>

<span class="co"># Summarise and combine all chains of interest for plotting</span>
<span class="va">posterior_summaries</span> <span class="op">&lt;-</span>
  <span class="va">posterior_school_effects</span> <span class="op">%&gt;%</span>
  <span class="fu">gather</span><span class="op">(</span>key <span class="op">=</span> <span class="va">school</span>, value <span class="op">=</span> <span class="va">value</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">group_by</span><span class="op">(</span><span class="va">school</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise_all</span><span class="op">(</span><span class="fu">funs</span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span><span class="op">)</span><span class="op">)</span> 

<span class="va">school_summaries</span> <span class="op">&lt;-</span> 
  <span class="va">posterior_summaries</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>tool <span class="op">=</span> <span class="st">"greta"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../../reference/extract-replace-combine.html">rbind</a></span><span class="op">(</span><span class="va">edward2_school_means</span><span class="op">)</span>

<span class="va">population_parameters</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="va">avg_effect</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">summarise_all</span><span class="op">(</span><span class="fu">funs</span><span class="op">(</span><span class="va">mean</span>, <span class="va">sd</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>tool <span class="op">=</span> <span class="st">"greta"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../../reference/extract-replace-combine.html">rbind</a></span><span class="op">(</span><span class="va">edward2_pop_mean</span><span class="op">)</span>

<span class="fu">ggplot</span><span class="op">(</span><span class="va">school_summaries</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">school</span>, y <span class="op">=</span> <span class="va">mean</span>, color <span class="op">=</span> <span class="va">tool</span>, shape <span class="op">=</span> <span class="va">tool</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_errorbar</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">mean</span> <span class="op">-</span> <span class="va">sd</span>, ymax <span class="op">=</span> <span class="va">mean</span> <span class="op">+</span> <span class="va">sd</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_hline</span><span class="op">(</span>data <span class="op">=</span> <span class="va">population_parameters</span>, 
             <span class="fu">aes</span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">mean</span>, linetype <span class="op">=</span> <span class="st">'Population mean'</span>, color <span class="op">=</span> <span class="va">tool</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">scale_linetype_manual</span><span class="op">(</span>name <span class="op">=</span> <span class="st">""</span>, values <span class="op">=</span> <span class="fu"><a href="../../reference/extract-replace-combine.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
</div>
</div>
</div>
<div id="session-information" class="section level2">
<h2 class="hasAnchor">
<a href="#session-information" class="anchor"></a>Session information</h2>
<div class="fold o">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <ul class="nav nav-pills nav-stacked">
<li><a href="#data">Data</a></li>
      <li><a href="#modelling-with-greta">Modelling with <code>greta</code></a></li>
      <li><a href="#session-information">Session information</a></li>
      </ul>
</div>
      </div>

</div>



      <footer></footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: 'fa1406e0044eae29be11408a723039e7',
    indexName: 'greta',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
